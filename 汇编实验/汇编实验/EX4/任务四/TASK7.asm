    NAME MOD1
    EXTRN DTOC: NEAR, MODIFY_INFO: NEAR, RECCOMEND_CAL: NEAR, SORT: NEAR
    PUBLIC N, GA1

.386 
DATA SEGMENT USE16 PARA PUBLIC 'DATA'
BNAME DB 'n' ,'h' ,'y',0,0 ;老板姓名（必须是自己名字的拼音） 
BPASS DB ('1'-30H)*2 ,('2'-30H)*2 ,('3'-30H)*2 ;密码 
N EQU 10
S1 DB 'SHOP',0,10;网店名称，用0结束 
GA1 DB 'PEN',7 DUP(0) ,10;商品名称及折扣
DW 35,56,1000,0,? ;推荐度还未计算 
GA2 DB 'BOOK',6 DUP(0),9 ; 商品名称及折扣
DW 12,30,180,5,? ;推荐度还未计算
GA3 DB 'APPLE',5 DUP(0),8 ; 商品名称及折扣
DW 2,4,40,25,? ;推荐度还未计算
GA5 DB 'CARD',6 DUP(0),10 ; 商品名称及折扣
DW 1,0,40,30,? ;推荐度还未计算
GA6 DB 'CLOTHS',4 DUP(0),6 ; 商品名称及折扣
DW 35,60,24,18,? ;推荐度还未计算
GA7 DB 'RUBBER',4 DUP(0),6 ; 商品名称及折扣
DW 3,4,10,9,? ;推荐度还未计算
GAN  DB N-7 DUP('Temp-Value',8,15,0,20,0,30,0,2,0,?,?)
GA4 DB 'SHOES',5 DUP(0),7 ; 商品名称及折扣
DW 16,25,500,0,? ;推荐度还未计算
SORTED DB N DUP(?,?)

AUTH DB 0 
DB ?
DB ?

RANK DW 0

OLDINT1 DW  0,0               ;1号中断的原中断矢量（用于中断矢量表反跟踪）
OLDINT3 DW  0,0               ;3号中断的原中断矢量

INPUTBOSSNAME     DB 'PLEASE INPUT THE BOSS NAME:$'
INPUTPASSWORD     DB 'PLEASE INPUT THE PASSWORD:$'
INPUTGOODSNAME    DB 'PLEASE INPUT THE GOODS NAME:$'
FAIL              DB 'LOGININ FAILED! TRYAGAIN!$'
SUCCESS           DB 'LOGININ SUCCESSFULLY!$'
NOTHAVEGOODS      DB 'THE GOODS DOES NOT EXITS! TRYAGAIN!$'
MENUHEAD		  DB '      |                 MENU                 |$'
MENU1			  DB '      |1_Query product information           |$'
MENU2			  DB '      |2_Modify product information          |$'
MENU3			  DB '      |3_Calculate recommendation degree     |$'
MENU4			  DB '      |4_Calculate the recommendation ranking|$'
MENU5			  DB '      |5_Output all product information      |$'
MENU6			  DB '      |6_Program exit!                       |$'
MENULAST		  DB 'Enter the number 1-6 to enter the corresponding function:$'
ILLEGALNUMBER	  DB 'Please enter the right number!$'

IN_NAME  DB 16
		 DB ?
		 DB 16 DUP(0)
IN_PWD   DB 10
		 DB ?
		 DB 10 DUP(0)
IN_GOODS DB 10
	     DB ?
	     DB 10 DUP(0)
IN_FUNCTION DB 8
	        DB ?
	        DB 8 DUP(0)
CRLF     DB 0DH,0AH,'$'
DATA ENDS

STACK SEGMENT USE16 PARA STACK 'STACK'
	DB 100 DUP(0)
STACK ENDS

WRITE	MACRO A
		lea dx, A
		mov ah, 9
		int 21H
		mov dx, 0AH
		mov ah, 2
		int 21H
ENDM

CODE SEGMENT USE16 PARA PUBLIC 'CODE'
ASSUME CS:CODE, DS:DATA ,SS:STACK
NEWINT: IRET

START:  
	MOV AX,STACK
	MOV SS,AX
	MOV AX,DATA 
    MOV DS,AX
	XOR AX,AX
	MOV ES,AX
	mov  ax,es:[1*4]            ;保存原1号和3号中断矢量
    mov  OLDINT1,ax
    mov  ax,es:[1*4+2]
    mov  OLDINT1+2,ax
    mov  ax,es:[3*4]
    mov  OLDINT3,ax
    mov  ax,es:[3*4+2]
    mov  OLDINT3+2,ax
    cli                           ;设置新的中断矢量
    mov  ax,OFFSET NEWINT
    mov  es:[1*4],ax
    mov  es:[1*4+2],cs
    mov  es:[3*4],ax
    mov  es:[3*4+2],cs
    sti
	MOV SI,OFFSET S1
		
SHOP: ;输出SHOP字符
	MOV DX,[SI]
	CMP DL,0
	JZ  OK
	MOV AH,2
	INT 21H
	JMP NEXT
		
NAMEINPUT:  ;提示输入姓名，并要求输入
	LEA DX,INPUTBOSSNAME
	MOV AH,9
	INT 21H
	LEA DX,IN_NAME
	MOV AH,10
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
		
PASSWORDINPUT:   ;提示输入密码，并要求输入
	LEA DX,INPUTPASSWORD
	MOV AH,9
	INT 21H
	LEA DX,IN_PWD
	MOV AH,10
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H	
			
	MOV SI,OFFSET IN_NAME
	MOV DI,OFFSET BNAME
	MOV CX,[SI+1]
	MOV CH,0
	ADD SI,2
			
CHECKNAME:  ;检验姓名是否正确
	MOV AH,[SI]
	MOV AL,[DI]
	CMP AH,AL
	JNZ NOTRIGHTNAME
	INC SI
	INC DI
	LOOP CHECKNAME
			
	MOV AH,[SI]
	CMP AH,0DH
	JNZ NOTRIGHTNAME
			
	MOV SI,OFFSET IN_PWD
	MOV DI,OFFSET BPASS
	MOV CX,[SI+1]
	MOV CH,0
	ADD SI,2
				
CHECKPWD:   ;检验密码是否正确
	MOV AH,[SI]
	SUB AH,30H
	IMUL AH,2
	MOV AL,[DI]
	CMP AH,AL
	JNZ NOTRIGHTPWD
	INC SI
	INC DI
	LOOP CHECKPWD
			
	MOV AH,[SI]
	CMP AH,0DH
	JNZ NOTRIGHTPWD
			
	MOV SI,OFFSET AUTH
	MOV AX,1H
	MOV [SI],AX
	LEA DX,SUCCESS
	MOV AH,9
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
			
TASK3:
	CALL MENU
	
FUNCTION:
	LEA DX,MENULAST
	MOV AH,9
	INT 21H
	LEA DX,IN_FUNCTION
	MOV AH,10
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	
	MOV DI,OFFSET IN_FUNCTION
	MOV AL,1[DI]
	CMP AL,1
	JNZ ILLEGAL
	MOV SI,OFFSET AUTH
	MOV AX,[SI]
	CMP AX,0
	JZ Tourist
	JMP Boss

Boss:	
	MOV AL,2[DI]
	CMP AL,'1'
	JZ A
	CMP AL,'2'
	JZ B
	CMP AL,'3'
	JZ C3
	CMP AL,'4'
	JZ D
	CMP AL,'5'
	JZ E
	CMP AL,'6'
	JZ F
	JMP ILLEGAL
	
Tourist:
	MOV AL,2[DI]
	CMP AL,'1'
	JZ A
	CMP AL,'6'
	JZ F
	JMP ILLEGAL
	
A:
	CALL FINDGOODS
	CALL PRINT
	JMP TASK3
	
B:
	CALL WAN2
	JMP TASK3
	
C3:
	CALL WAN3
	JMP TASK3
	
D:
	CALL WAN4
	JMP TASK3
	
E:
	CALL WAN5
	JMP TASK3

F:
	CALL WAN6

WAN2	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI

	CALL FINDGOODS
	MOV BX,DI
	CALL MODIFY_INFO
	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
WAN2	ENDP

WAN3	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI

	CALL RECCOMEND_CAL
	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
WAN3	ENDP

WAN4	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI

	MOV DI,OFFSET GA1
	MOV CX,N
DO:
	PUSH DI
	ADD DI,21
	LOOP DO
	CALL SORT
	
	MOV SI,OFFSET SORTED
	MOV CX,N
P:
	POP [SI]
	ADD SI,2
	LOOP P
	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
WAN4	ENDP

WAN5	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI

	MOV CX,N
	MOV AX,1
	MOV BX,0
	MOV SI,OFFSET SORTED
Q:
	PUSH AX
	MOV DI,[SI]
	ADD SI,2
	MOV DX,[DI+19]
	CMP BX,DX
	MOV BX,DX
	JZ K
	MOV RANK,AX
	CALL DTOC
	CALL PRINT
	POP AX
	INC AX
	LOOP Q
	JMP FF
K:
	MOV AX,WORD PTR RANK
	CALL DTOC
	CALL PRINT
	POP AX
	INC AX
	LOOP Q
	JMP FF
FF:	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
WAN5	ENDP

WAN6	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI

	MOV AH,4CH
	INT 21H
	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
WAN6	ENDP

ILLEGAL:
	LEA DX,ILLEGALNUMBER
	MOV AH,9
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	JMP FUNCTION
											
EXIT:
	cli                           ;还原中断矢量
    mov  ax,OLDINT1
    mov  es:[1*4],ax
    mov  ax,OLDINT1+2
    mov  es:[1*4+2],ax
    mov  ax,OLDINT3
    mov  es:[3*4],ax
    mov  ax,OLDINT3+2
    mov  es:[3*4+2],ax 
    sti
	MOV AH,4CH
	INT 21H
	
TONAMEINPUT:   
	MOV DX,0AH
	MOV AH,2
	INT 21H
	JMP NAMEINPUT
		
RECOMMEND: 
	POP CX
	MOV AX,150D
	MOV WORD PTR[DI+19],AX
	ADD DI,21D
	DEC CX
	
NEXT:   
	INC SI
	JMP SHOP
		
OK:		
	MOV DX,0AH
	MOV AH,2
	INT 21H
	JMP NAMEINPUT
		
NOTRIGHTPWD:  ;密码错误
	LEA DX,FAIL
	MOV AH,9
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	JMP NAMEINPUT
			  
NOTRIGHTNAME: ;姓名错误
	MOV SI,OFFSET IN_NAME
	MOV DL,[SI+1]
	CMP DL,0
	JZ  WOR
	CMP DL,1
	JZ  ORW
	JNZ NOTRIGHTPWD
			  
ORW:		  
	MOV DL,[SI+2]
	CMP DL,'q'
	JZ  EXIT
	JNZ NOTRIGHTPWD
			  
WOR:		  
	MOV DL,[SI+2]
	CMP DL,0DH
	MOV SI,OFFSET AUTH
	MOV AX,0H
	MOV [SI],AX
	JZ  TASK3
	JMP NOTRIGHTPWD
	
MENU	PROC ;菜单
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI
	
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	MOV SI,OFFSET AUTH
	MOV AX,[SI]
	CMP AX,0
	JZ NOTLOGIN
	JMP LOGIN
	
NOTLOGIN:
	WRITE MENUHEAD
	WRITE MENU1
	WRITE MENU6
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	JMP LAST
	
LOGIN:
	WRITE MENUHEAD
	WRITE MENU1
	WRITE MENU2
	WRITE MENU3
	WRITE MENU4
	WRITE MENU5
	WRITE MENU6
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	JMP LAST

LAST:
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
MENU	ENDP

PRINT	PROC ;传入找到商品的首地址DI
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI
	PUSH DI
	
	MOV CX,2
PRINT1:
	MOV CX,2
	MOV DL,[DI]
	CMP DL,0H
	JZ  ALLIMFOR
	MOV AH,2
	INT 21H
	INC DI
	LOOP PRINT1 

ALLIMFOR:
	POP DI
	PUSH DI
	MOV AH,2
	MOV DL,32
	INT 21H
	MOV AX,0
	MOV AL,[DI+10]
	CALL DTOC
	MOV CX,5
	ADD DI,11
MORE:
	MOV AX,[DI]
	CALL DTOC
	ADD DI,2
	LOOP MORE
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
	
PRINT	ENDP
	
FINDGOODS	PROC
	PUSH AX
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH SI

GOODSINPUT: 
	LEA DX,INPUTGOODSNAME
	MOV AH,9
	INT 21H
	LEA DX,IN_GOODS
	MOV AH,10
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H	
	  
	MOV SI,OFFSET IN_GOODS
	MOV DI,OFFSET GA1
	PUSH DI
	MOV BX,N
		
DEFCX:		
	MOV CX,[SI+1]
	MOV CH,0
	CMP CX,0
	JZ TASK3
	MOV DX,DI
						
CHECKGOODS: ;检验商品是否存在
	MOV AH,[SI+2]
	MOV AL,[DI]
	CMP AH,AL
	JNZ DIF
	INC SI
	INC DI
	LOOP CHECKGOODS
	JMP FINAL 
		
DIF:	
	POP DI
	ADD DI,21
	PUSH DI
	MOV SI,OFFSET IN_GOODS
	DEC BX
	CMP BX,0
	JZ  RESET
	JMP DEFCX
		
RESET:  
	LEA DX,NOTHAVEGOODS
	MOV AH,9
	INT 21H
	LEA DX,CRLF
	MOV AH,9
	INT 21H
	JMP GOODSINPUT
		
FINAL:	
	MOV AL,[DI]
	CMP AL,0
	JZ  O
	JMP DIF

O:
	POP DI
	POP SI
	POP DX
	POP CX
	POP BX
	POP AX
	RET
FINDGOODS	ENDP

CODE ENDS
END START
